<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>New Tab</title>

    <style>
        body {
            background: #000;
            color: #fff;
            margin: 0;
            font-family: Helvetica, sans-serif;
            min-height: 100vh;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin-top: 64px;
        }
        #favoritesGrid {
            margin-bottom: 64px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 32px;
            margin-top: 48px;
        }
        .cell {
            background: #111;
            border-radius: 12px;
            padding: 16px 12px 12px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            width: 128px;
        }
        .cell:hover {
            background: #181818;
        }
        .cell.drag-over {
            background: #222 !important;
            outline: 2px dashed #fff;
        }
        .cell.dragging {
            opacity: 0.5;
        }

        .favicon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background: #222;
            object-fit: contain;
            margin-bottom: 12px;
        }
        .site-name {
            color: #fff;
            font-size: 0.8em;
            text-align: center;
            margin-bottom: 4px;
            word-break: break-word;
        }
        .edit-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
            width: 22px;
            height: 22px;
            opacity: 0.7;
        }
        .edit-icon:hover {
            opacity: 1;
        }
        .add-btn {
            position: fixed;
            top: 24px;
            right: 32px;
            background: #222;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #0008;
        }
        .modal-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal {
            background: #222;
            padding: 32px 24px 24px 24px;
            border-radius: 16px;
            min-width: 320px;
            color: #fff;
            box-shadow: 0 4px 24px #000c;
        }
        .modal label {
            display: block;
            margin-bottom: 8px;
            font-size: 1em;
        }
        .modal input {
            width: 95%;
            padding: 8px;
            margin-bottom: 18px;
            border-radius: 6px;
            border: none;
            background: #333;
            color: #fff;
            font-size: 1em;
        }
        .modal .actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .modal button {
            background: #444;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 18px;
            font-size: 1em;
            cursor: pointer;
        }
        .modal button:hover {
            background: #666;
        }

        /* --- New styles for icon selection --- */
        .icon-choice {
            position: relative;
            cursor: pointer;
            border-radius: 10px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 4px #0004;
            transition: background 0.3s, border 0.3s;
        }
        .icon-choice img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #222;
            object-fit: contain;
        }
        .icon-choice span {
            margin-left: 10px;
            color: #fff;
        }
        #iconSelector {
            margin-bottom: 18px;
        }
        #iconSelector div {
            display: flex;
            gap: 18px;
        }
        #iconSelector label {
            color: #fff;
        }
        #customIconInput {
            width: 70%;
            padding: 6px;
            border-radius: 6px;
            border: none;
            background: #333;
            color: #fff;
        }
        #customIconPreview {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #222;
            overflow: hidden;
            line-height: 40px;
            text-align: center;
            font-size: 2em;
            color: #a00;
        }
        /* Spin animation for refresh icon */
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <button class="add-btn" title="Add site" id="addSiteBtn">+</button>
    <div class="container">
        <div class="grid" id="favoritesGrid"></div>
        <div id="newsSection"></div>
    </div>
    <div id="modalRoot"></div>
    <script>

        // --- Data Model ---
        const SITES_STORAGE_KEY = 'favoriteSites';
        const NEWS_STORAGE_KEY  = 'newsArticles';
        const NEWS_API_KEY      = localStorage.getItem('newsApiKey') || '';
        const NEWS_API_URL      = `https://newsapi.org/v2/top-headlines?country=us&apiKey=${NEWS_API_KEY}`;

        function debounce(func, delay) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function loadSites() {
            try {
                return JSON.parse(localStorage.getItem(SITES_STORAGE_KEY)) || [];
            } catch {
                return [];
            }
        }
        function saveSites(sites) {
            localStorage.setItem(SITES_STORAGE_KEY, JSON.stringify(sites));
        }

        // --- Favicon Fetch ---
        function getFaviconUrl(siteUrl) {
            try {
                const url = new URL(siteUrl);
                return `https://icons.duckduckgo.com/ip3/${url.host}.ico`;
            } catch {
                return '';
            }
        }

        // --- URL Scheme Helper ---
        function prependHttpSchemeIfNeeded(url) {
            if (!url.match(/^https?:\/\/.+/)) {
                url = 'http://' + url; // Default to http if no scheme
            }
            return url
        }

        // --- Render Grid ---
        async function renderGrid() {
            const grid = document.getElementById('favoritesGrid');
            grid.innerHTML = '';
            const sites = loadSites();
            for (let i = 0; i < sites.length; i++) {
                const site = sites[i];
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.title = site.url;
                cell.draggable = true;
                cell.dataset.index = i;

                // Drag state tracking
                let dragStarted = false;

                // Drag events for reordering
                cell.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', i);
                    cell.classList.add('dragging');
                    dragStarted = true;
                });
                cell.addEventListener('dragend', () => {
                    cell.classList.remove('dragging');
                    dragStarted = false;
                });

                cell.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    cell.classList.add('drag-over');
                });
                cell.addEventListener('dragleave', () => {
                    cell.classList.remove('drag-over');
                });
                cell.addEventListener('drop', (e) => {
                    e.preventDefault();
                    cell.classList.remove('drag-over');
                    const fromIndex = Number(e.dataTransfer.getData('text/plain'));
                    const toIndex = Number(cell.dataset.index);
                    if (fromIndex === toIndex) return;
                    const sites = loadSites();
                    const [moved] = sites.splice(fromIndex, 1);
                    sites.splice(toIndex, 0, moved);
                    saveSites(sites);
                    renderGrid();
                });

                // Link wraps favicon and site name
                const link = document.createElement('a');
                link.rel = 'noopener noreferrer';
                link.style.display = 'flex';
                link.style.flexDirection = 'column';
                link.style.alignItems = 'center';
                link.style.width = '100%';
                link.style.textDecoration = 'none';
                link.href = site.url;

                // Only allow navigation if not dragging
                link.addEventListener('click', function(e) {
                    // If a drag was started, prevent navigation
                    if (dragStarted) {
                        e.preventDefault();
                        dragStarted = false;
                    }
                });

                const favicon = document.createElement('img');
                favicon.className = 'favicon';
                favicon.src = site.favicon;
                favicon.onerror = () => {
                    favicon.src = getFaviconUrl(site.url);
                };
                link.appendChild(favicon);

                const nameDiv = document.createElement('div');
                nameDiv.className = 'site-name';
                nameDiv.textContent = site.name;
                link.appendChild(nameDiv);

                cell.appendChild(link);

                // Edit Icon (outside link)
                const editIcon = document.createElement('img');
                editIcon.className = 'edit-icon';
                editIcon.src = 'data:image/svg+xml;utf8,<svg width="22" height="22" viewBox="0 0 24 24" fill="gray" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>';
                editIcon.title = 'Edit';
                editIcon.onclick = () => openEditModal(i, site);
                cell.appendChild(editIcon);

                grid.appendChild(cell);
            }
        }

        // --- Global setSpinning for news refresh icon ---
        function setSpinning(spin) {
            const refreshSvg = document.getElementById('newsRefreshSvg');
            if (refreshSvg) {
                refreshSvg.style.animation = spin
                    ? "spin 1s linear infinite"
                    : "";
            }
        }

        function renderNews() {
            const newsSection = document.getElementById('newsSection');
            // Add refresh icon and gear icon after "Top News"
            newsSection.innerHTML = `
                <div style="margin-top:48px;color:#fff;font-size:1.3em;font-weight:bold;display:flex;align-items:center;gap:12px;position:relative;">
                    Top News
                    <span id="newsRefreshIcon" style="cursor:pointer;display:inline-flex;align-items:center;">
                        <svg id="newsRefreshSvg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="gray"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                    </span>
                    <span id="newsSettingsIcon" title="Manage News API Key" style="cursor:pointer;display:inline-flex;align-items:center;margin-left:auto;">
                        <svg width="22" height="22" viewBox="0, 0, 300, 300" xmlns="http://www.w3.org/2000/svg">
                            <g>
                                <title>Gear Icon</title>
                                <circle stroke="gray" stroke-width="60" stroke-dasharray="53.86,53.86" fill="none" cx="150" cy="150" r="120"/>
                                <circle stroke="gray" stroke-width="60"                                fill="none" cx="150" cy="150" r="90"/>
                            </g>
                        </svg>
                    </span>
                </div>
            `;

            const refreshIcon = document.getElementById('newsRefreshIcon');
            const refreshSvg = document.getElementById('newsRefreshSvg');
            let isFetching = false;

            // Add gear icon click handler
            const settingsIcon = document.getElementById('newsSettingsIcon');
            if (settingsIcon) {
                settingsIcon.onclick = () => {
                    openApiKeyModal();
                };
            }

            refreshIcon.onclick = () => {
                localStorage.removeItem(NEWS_STORAGE_KEY);
                setSpinning(true);
                fetchAndRenderNews(true);
            };

            function fetchAndRenderNews(forceFetch = false) {
                let cached = null;
                try {
                    cached = JSON.parse(localStorage.getItem(NEWS_STORAGE_KEY));
                } catch {}
                let useCache = false;
                // Re-read API key in case it was just set
                const NEWS_API_KEY = localStorage.getItem('newsApiKey') || '';
                const NEWS_API_URL = `https://newsapi.org/v2/top-headlines?country=us&apiKey=${NEWS_API_KEY}`;
                if (!forceFetch && cached && cached.fetchedAt) {
                    const ageMs = Date.now() - new Date(cached.fetchedAt).getTime();
                    const twoHours = 2 * 60 * 60 * 1000;
                    if (ageMs < twoHours && cached.articles && cached.articles.length > 0) {
                        useCache = true;
                    }
                }

                function renderArticles(articles) {
                    setSpinning(false);
                    const container = document.createElement('div');
                    container.style.display = 'flex';
                    container.style.flexDirection = 'column';
                    container.style.gap = '18px';
                    container.style.marginTop = '18px';
                    container.style.width = '60vw';
                    container.style.maxWidth = '900px';
                    container.style.marginLeft = 'auto';
                    container.style.marginRight = 'auto';

                    function formatAge(publishedAt) {
                        if (!publishedAt) return '';
                        const pubDate = new Date(publishedAt);
                        const now = new Date();
                        const diffMs = now - pubDate;
                        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        const diffMins = Math.floor(diffMs / (1000 * 60));
                        let display = '';
                        if (diffMs < 0) {
                            display = 'just now';
                        } else if (diffHours < 1) {
                            display = `${diffMins} min${diffMins !== 1 ? 's' : ''}`;
                        } else if (diffHours < 24) {
                            display = `${diffHours} hour${diffHours !== 1 ? 's' : ''}`;
                        } else if (diffDays < 2) {
                            const hours = diffHours % 24;
                            display = `${diffDays} day${diffDays !== 1 ? 's' : ''}` +
                                (hours > 0 ? ` ${hours} hour${hours !== 1 ? 's' : ''}` : '');
                        } else {
                            display = pubDate.toLocaleDateString(undefined, {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        }
                        const tooltip = pubDate.toLocaleString();
                        return { display, tooltip };
                    }

                    articles.forEach(article => {
                        const rowLink = document.createElement('a');
                        rowLink.href = article.url || '#';
                        rowLink.style.display = 'flex';
                        rowLink.style.alignItems = 'flex-start';
                        rowLink.style.background = '#181818';
                        rowLink.style.borderRadius = '10px';
                        rowLink.style.padding = '12px 16px';
                        rowLink.style.gap = '18px';
                        rowLink.style.boxShadow = '0 2px 8px #0006';
                        rowLink.style.textDecoration = 'none';

                        const img = document.createElement('img');
                        img.src = article.urlToImage || '';
                        img.style.width = '256px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '8px';
                        img.style.background = '#222';
                        img.style.margin = 'auto';
                        img.onerror = () => { img.style.display = 'none'; };

                        const info = document.createElement('div');
                        info.style.display = 'flex';
                        info.style.flexDirection = 'column';
                        info.style.justifyContent = 'flex-start';
                        info.style.flex = '1';

                        const title = document.createElement('div');
                        let titleTokens = (article.title || '').split('-');
                        titleTokens.pop();
                        title.textContent = titleTokens.join('-').trim();
                        title.style.color = '#fff';
                        title.style.fontSize = '1.2em';
                        title.style.padding = '12px';

                        const desc = document.createElement('div');
                        desc.textContent = article.description || '';
                        desc.style.color = '#ccc';
                        desc.style.fontSize = '0.95em';
                        desc.style.marginBottom = '4px';
                        desc.style.padding = '12px';

                        const source = document.createElement('div');
                        source.style.display = 'inline';
                        source.style.color = '#aaa';
                        source.style.fontSize = '0.85em';
                        source.style.padding = '4px 12px 0 12px';

                        const { display: ageDisplay, tooltip: ageTooltip } = formatAge(article.publishedAt);
                        source.textContent = article.source && article.source.name ? article.source.name : '';

                        const ageSpan = document.createElement('span');
                        ageSpan.textContent = ageDisplay ? ` - ${ageDisplay}` : '';
                        ageSpan.title = ageTooltip;
                        ageSpan.style.color = '#444';
                        ageSpan.style.marginLeft = '2px';

                        source.appendChild(ageSpan);

                        info.appendChild(title);
                        info.appendChild(desc);
                        info.appendChild(source);

                        rowLink.appendChild(img);
                        rowLink.appendChild(info);

                        container.appendChild(rowLink);
                    });

                    // Remove previous articles if any
                    while (newsSection.children.length > 1) {
                        newsSection.removeChild(newsSection.lastChild);
                    }
                    newsSection.appendChild(container);
                }

                function showApiKeyUi(message) {
                    newsSection.innerHTML += `<div style="color:#a00;margin-top:12px;display:flex;flex-direction:column;align-items:center;width:100%;">
                        <button id="addApiKeyBtn" style="display:inline-flex;align-items:center;gap:8px;background:#222;color:#fff;border:none;border-radius:6px;padding:10px 18px;font-size:1em;cursor:pointer;box-shadow:0 2px 8px #0006;">
                            <span style="display:inline-flex;align-items:center;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="gray" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="8" cy="15" r="3"/>
                                    <path d="M10.6 13L20 4.2M19 5.5l2 2M16.5 7.5l2 2"/>
                                </svg>
                            </span>
                            Click here to add API Key
                        </button>
                        <span style="color:#888;font-size:0.80em;margin-top:8px;text-align:center;display:block;">
                            ${message ? message : `<a href="https://newsapi.org/register" target="_blank" style="color:#b00;text-decoration:underline;">Sign up for a free API key NewsAPI.org</a>`}
                        </span>
                    </div>`;
                    setTimeout(() => {
                        const btn = document.getElementById('addApiKeyBtn');
                        if (btn) btn.onclick = (e) => {
                            e.preventDefault();
                            openApiKeyModal();
                        };
                    }, 0);
                }

                // If there's no API key, show message and skip fetch
                if (!NEWS_API_KEY) {
                    setSpinning(false);
                    showApiKeyUi();
                    return;
                }

                if (useCache) {
                    renderArticles(cached.articles);
                } else {
                    setSpinning(true);
                    const proxiedUrl = 'https://corsproxy.io/?' + encodeURIComponent(NEWS_API_URL);
                    fetch(proxiedUrl)
                        .then(response => response.json())
                        .then(data => {
                            // Handle NewsAPI 401 error with apiKeyInvalid
                            if (
                                data &&
                                data.status === "error" &&
                                data.code === "apiKeyInvalid" &&
                                typeof data.message === "string"
                            ) {
                                setSpinning(false);
                                showApiKeyUi(data.message);
                                return;
                            }
                            let storage = {
                                articles: data.articles || [],
                                fetchedAt: new Date().toISOString()
                            };
                            localStorage.setItem(NEWS_STORAGE_KEY, JSON.stringify(storage));
                            renderArticles(storage.articles);
                        })
                        .catch(error => {
                            setSpinning(false);
                            newsSection.innerHTML += '<div style="color:#a00;">Error fetching news.</div>';
                        });
                }
            }

            fetchAndRenderNews();
        }

        // --- Favorite Site Modal ---
        function showFavoriteModal({ title, name, url, onSave, onDelete, selectedIconType, selectedCustomUrl }) {
            const modalRoot = document.getElementById('modalRoot');
            let currentUrl = url || '';
            let hostname = '';
            try { hostname = new URL(currentUrl).hostname; } catch {}
            let googleIconUrl = hostname ? `http://www.google.com/s2/favicons?domain=${hostname}&sz=64` : '';
            let duckIconUrl = hostname ? `https://icons.duckduckgo.com/ip3/${hostname}.ico` : '';
            let iconError = false;
            let _selectedIconType = typeof selectedIconType === 'string' ? selectedIconType : null;
            let _selectedCustomUrl = typeof selectedCustomUrl === 'string' ? selectedCustomUrl : '';

            function getSelectedFavicon() {
                if (_selectedIconType === 'google') return googleIconUrl;
                if (_selectedIconType === 'duck') return duckIconUrl;
                if (_selectedIconType === 'custom') return _selectedCustomUrl;
                return '';
            }

            function renderIconSelector() {
                // Helper for fallback preview
                function iconImgOrUnknown(src, id) {
                    if (!src) {
                        return `<span style="width:40px;height:40px;display:inline-block;line-height:40px;text-align:center;font-size:2em;color:#888;" id="${id}Fallback">‚ùî</span>`;
                    }
                    return `<img src="${src}" id="${id}" style="width:40px;height:40px;border-radius:8px;background:#222;object-fit:contain;" onerror="this.style.display='none';document.getElementById('${id}Fallback').style.display='inline-block';">
                            <span style="display:none;width:40px;height:40px;line-height:40px;text-align:center;font-size:2em;color:#888;" id="${id}Fallback">‚ùî</span>`;
                }
                return `
                    <fieldset id="iconSelectorFieldset" style="margin-bottom:18px;border:2px solid #444;border-radius:16px;padding:18px 18px 18px 18px;position:relative;">
                        <legend style="padding:0 12px;font-size:1.1em;color:#aaa;font-weight:bold;background:#222;left:12px;">Icon</legend>
                        <div style="display:flex;justify-content:center;gap:32px;margin-bottom:18px;">
                            <div class="icon-choice" id="iconChoiceGoogle" style="position:relative;cursor:pointer;border-radius:12px;padding:14px 32px 14px 20px;display:flex;align-items:center;box-shadow:0 1px 4px #0004;background:${_selectedIconType==='google'?'#333':'#222'};border:${_selectedIconType==='google'?'2.5px solid #4af':'2px solid transparent'};min-width:120px;">
                                ${iconImgOrUnknown(googleIconUrl, "iconPreviewGoogle")}
                                <span style="margin-left:16px;color:#fff;font-size:1.05em;">Google</span>
                                <span id="checkGoogle" style="position:absolute;top:6px;right:10px;${_selectedIconType==='google'?'display:block':'display:none'};">
                                    <svg width="22" height="22" viewBox="0 0 24 24"><polyline points="5,13 10,18 19,7" style="fill:none;stroke:#1ec94c;stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </span>
                            </div>
                            <div class="icon-choice" id="iconChoiceDuck" style="position:relative;cursor:pointer;border-radius:12px;padding:14px 32px 14px 20px;display:flex;align-items:center;box-shadow:0 1px 4px #0004;background:${_selectedIconType==='duck'?'#333':'#222'};border:${_selectedIconType==='duck'?'2.5px solid #4af':'2px solid transparent'};min-width:120px;">
                                ${iconImgOrUnknown(duckIconUrl, "iconPreviewDuck")}
                                <span style="margin-left:16px;color:#fff;font-size:1.05em;">DuckDuckGo</span>
                                <span id="checkDuck" style="position:absolute;top:6px;right:10px;${_selectedIconType==='duck'?'display:block':'display:none'};">
                                    <svg width="22" height="22" viewBox="0 0 24 24"><polyline points="5,13 10,18 19,7" style="fill:none;stroke:#1ec94c;stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </span>
                            </div>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center;">
                            <label style="color:#fff;font-weight:bold;text-align:center;margin-bottom:6px;font-size:1.05em;">Custom Icon</label>
                            <input type="url" id="customIconInput" value="${_selectedCustomUrl||''}" placeholder="https://domain.com/icon.ext" style="width:80%;max-width:320px;padding:8px 10px;border-radius:8px;border:none;background:#333;color:#fff;text-align:center;margin-bottom:10px;font-size:1em;">
                            <div id="iconChoiceCustom" style="position:relative;cursor:pointer;border-radius:12px;padding:0;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 4px #0004;background:${_selectedIconType==='custom'?'#333':'#222'};border:${_selectedIconType==='custom'?'2.5px solid #4af':'2px solid transparent'};width:54px;height:54px;margin-bottom:0;">
                                <span id="customIconPreview" style="display:inline-block;width:40px;height:40px;border-radius:8px;background:#222;overflow:hidden;line-height:40px;text-align:center;font-size:2em;color:#a00;">
                                    ${iconError ? 'üö´' : (_selectedCustomUrl ? `<img src="${_selectedCustomUrl}" style="width:40px;height:40px;object-fit:contain;border-radius:8px;" onerror="this.parentNode.innerHTML='üö´';">` : '')}
                                </span>
                                <span id="checkCustom" style="position:absolute;top:2px;right:2px;${_selectedIconType==='custom'?'display:block':'display:none'};">
                                    <svg width="18" height="18" viewBox="0 0 24 24"><polyline points="5,13 10,18 19,7" style="fill:none;stroke:#1ec94c;stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </span>
                            </div>
                        </div>
                    </fieldset>
                `;
            }

            modalRoot.innerHTML = `
                <div class="modal-bg">
                    <div class="modal">
                        <h2 style="margin-top:0;">${title}</h2>
                        <form id="modalForm">
                            <label>Site Name</label>
                            <input type="text" id="modalName" value="${name || ''}" autocomplete="off">
                            <label>Site URL</label>
                            <input type="url" id="modalUrl" value="${url || ''}" autocomplete="off" placeholder="https://example.com">
                            <div id="iconSelectorContainer">${renderIconSelector()}</div>
                            <div class="actions">
                                ${onDelete ? '<button type="button" id="deleteBtn" style="background:#a00;">Delete</button>' : ''}
                                <button type="button" id="cancelBtn">Cancel</button>
                                <button type="submit" id="saveBtn">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const nameInput = document.getElementById('modalName');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.select();
                }
            }, 0);

            function updateIconUrls() {
                try {
                    hostname = new URL(document.getElementById('modalUrl').value.trim()).hostname;
                } catch { hostname = ''; }
                googleIconUrl = hostname ? `http://www.google.com/s2/favicons?domain=${hostname}&sz=64` : '';
                duckIconUrl = hostname ? `https://icons.duckduckgo.com/ip3/${hostname}.ico` : '';
            }

            function rerenderIconSelector() {
                const active = document.activeElement;
                const isCustomInput = active && active.id === 'customIconInput';
                const caret = isCustomInput ? active.selectionStart : null;
                document.getElementById('iconSelectorContainer').innerHTML = renderIconSelector();
                attachIconSelectorEvents();
                if (isCustomInput) {
                    const input = document.getElementById('customIconInput');
                    if (input) {
                        input.focus();
                        if (caret !== null) input.setSelectionRange(caret, caret);
                    }
                }
            }

            function attachIconSelectorEvents() {
                const googleDiv = document.getElementById('iconChoiceGoogle');
                if (googleDiv) {
                    googleDiv.onclick = () => {
                        _selectedIconType = 'google';
                        rerenderIconSelector();
                    };
                }
                const duckDiv = document.getElementById('iconChoiceDuck');
                if (duckDiv) {
                    duckDiv.onclick = () => {
                        _selectedIconType = 'duck';
                        rerenderIconSelector();
                    };
                }
                const customDiv = document.getElementById('iconChoiceCustom');
                if (customDiv) {
                    customDiv.onclick = () => {
                        _selectedIconType = 'custom';
                        rerenderIconSelector();
                    };
                }
                const customInput = document.getElementById('customIconInput');
                if (customInput) {
                    customInput.oninput = (e) => {
                        const pos = customInput.selectionStart;
                        _selectedCustomUrl = customInput.value.trim();
                        iconError = false;
                        if (_selectedCustomUrl) {
                            const img = new window.Image();
                            img.onload = () => {
                                iconError = false;
                                rerenderIconSelector();
                            };
                            img.onerror = () => {
                                iconError = true;
                                rerenderIconSelector();
                            };
                            img.src = _selectedCustomUrl;
                        } else {
                            rerenderIconSelector();
                        }
                        setTimeout(() => {
                            customInput.focus();
                            if (typeof pos === 'number') customInput.setSelectionRange(pos, pos);
                        }, 0);
                    };
                }
            }

            document.getElementById('modalUrl').addEventListener('input', debounce(() => {
                updateIconUrls();
                rerenderIconSelector();
            }, 400));

            attachIconSelectorEvents();

            function escHandler(e) {
                if (e.key === 'Escape') {
                    modalRoot.innerHTML = '';
                    window.removeEventListener('keydown', escHandler);
                }
            }
            window.addEventListener('keydown', escHandler);

            document.getElementById('cancelBtn').onclick = () => {
                modalRoot.innerHTML = '';
                window.removeEventListener('keydown', escHandler);
            };
            if (onDelete) {
                document.getElementById('deleteBtn').onclick = () => {
                    modalRoot.innerHTML = '';
                    window.removeEventListener('keydown', escHandler);
                    onDelete();
                };
            }
            const saveHandler = async (e) => {
                if (e) e.preventDefault();
                const newName = document.getElementById('modalName').value.trim();
                let newUrl = document.getElementById('modalUrl').value.trim();
                let favicon = getSelectedFavicon();
                modalRoot.innerHTML = '';
                window.removeEventListener('keydown', escHandler);
                await onSave(newName, newUrl, favicon);
            };
            document.getElementById('modalForm').onsubmit = saveHandler;
            document.getElementById('saveBtn').onclick = saveHandler;
        }

        // --- News API Key Modal ---
        function showApiKeyModal({ title, apiKey, onSave }) {
            const modalRoot = document.getElementById('modalRoot');
            modalRoot.innerHTML = `
                <div class="modal-bg">
                    <div class="modal">
                        <h2 style="margin-top:0;">${title}</h2>
                        <form id="apiKeyForm">
                            <label>API Key</label>
                            <input type="text" id="apiKeyInput" value="${apiKey || ''}" autocomplete="off" placeholder="Paste your NewsAPI.org key here">
                            <div class="actions">
                                <button type="button" id="cancelBtn">Cancel</button>
                                <button type="submit" id="saveBtn">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            setTimeout(() => {
                const input = document.getElementById('apiKeyInput');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 0);

            function escHandler(e) {
                if (e.key === 'Escape') {
                    modalRoot.innerHTML = '';
                    window.removeEventListener('keydown', escHandler);
                }
            }
            window.addEventListener('keydown', escHandler);

            document.getElementById('cancelBtn').onclick = () => {
                modalRoot.innerHTML = '';
                window.removeEventListener('keydown', escHandler);
            };
            const saveHandler = async (e) => {
                if (e) e.preventDefault();
                const key = document.getElementById('apiKeyInput').value.trim();
                modalRoot.innerHTML = '';
                window.removeEventListener('keydown', escHandler);
                await onSave(key);
            };
            document.getElementById('apiKeyForm').onsubmit = saveHandler;
            document.getElementById('saveBtn').onclick = saveHandler;
        }

        // --- Modal Logic ---
        function openEditModal(index, site) {
            // Determine which icon type was previously selected
            let selectedIconType = 'duck';
            let selectedCustomUrl = '';
            let hostname = '';
            try { hostname = new URL(site.url).hostname; } catch {}
            const googleIconUrl = hostname ? `http://www.google.com/s2/favicons?domain=${hostname}&sz=64` : '';
            const duckIconUrl = hostname ? `https://icons.duckduckgo.com/ip3/${hostname}.ico` : '';
            if (site.favicon === googleIconUrl) {
                selectedIconType = 'google';
            } else if (site.favicon === duckIconUrl) {
                selectedIconType = 'duck';
            } else if (site.favicon && site.favicon !== '') {
                selectedIconType = 'custom';
                selectedCustomUrl = site.favicon;
            }
            showFavoriteModal({
                title: 'Edit Favorite',
                name: site.name,
                url: site.url,
                selectedIconType,
                selectedCustomUrl,
                onSave: async (name, url, favicon) => {
                    const sites = loadSites();
                    sites[index].name = name;
                    sites[index].url = url;
                    sites[index].favicon = favicon || getFaviconUrl(url);
                    saveSites(sites);
                    await renderGrid();
                },
                onDelete: () => {
                    const sites = loadSites();
                    sites.splice(index, 1);
                    saveSites(sites);
                    renderGrid();
                }
            });
        }

        function openAddModal() {
            showFavoriteModal({
                title: 'Add Favorite',
                name: '',
                url: '',
                selectedIconType: null,
                selectedCustomUrl: '',
                onSave: async (name, url, favicon) => {
                    url = prependHttpSchemeIfNeeded(url);
                    if (!name) name = url;
                    favicon = favicon || getFaviconUrl(url);
                    const sites = loadSites();
                    sites.push({ name, url, favicon });
                    saveSites(sites);
                    await renderGrid();
                }
            });
        }

        function openApiKeyModal() {
            showApiKeyModal({
                title: 'Set News API Key',
                apiKey: localStorage.getItem('newsApiKey') || '',
                onSave: async (apiKey) => {
                    localStorage.setItem('newsApiKey', apiKey.trim());
                    setSpinning(true);
                    renderNews();
                }
            });
        }

        // --- Add Button ---
        document.getElementById('addSiteBtn').onclick = openAddModal;

        // --- Initial Render ---
        renderGrid();
        renderNews();
    </script>
</body>
</html>
